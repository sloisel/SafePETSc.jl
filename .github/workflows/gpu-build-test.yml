name: GPU Build Test

on:
  workflow_dispatch:

jobs:
  test-gpu-build:
    name: Test CUDA build
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mpich libmpich-dev gfortran cmake python3 bison

      - name: Install CUDA toolkit
        run: |
          sudo apt-get install -y nvidia-cuda-toolkit
          nvcc --version

      - uses: julia-actions/setup-julia@v2
        with:
          version: '1.10'
          arch: x64

      - uses: julia-actions/cache@v2

      - name: Build package
        uses: julia-actions/julia-buildpkg@v1

      - name: Build PETSc with STRUMPACK + CUDA
        run: |
          julia --project=. -e '
            using SafePETSc
            println("Building PETSc with STRUMPACK + CUDA support...")
            SafePETSc.build_petsc_strumpack(with_cuda=true, verbose=true)
          ' < /dev/null

      - name: Verify build
        run: |
          julia --project=. -e '
            using SafePETSc
            @assert SafePETSc.petsc_strumpack_available() "STRUMPACK build not found!"
            println("âœ“ STRUMPACK library found at: ", SafePETSc.petsc_strumpack_library_path())
          '

      - name: Run basic tests with GPU-enabled STRUMPACK
        run: |
          LIB_PATH=$(julia --project=. -e 'using SafePETSc; print(SafePETSc.petsc_strumpack_library_path())')
          JULIA_PETSC_LIBRARY="$LIB_PATH" julia --project=. -e 'using Pkg; Pkg.test()'
